{% extends "base.html" %}


{% block nav %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="{{ url_for('home') }}">Inventory Management System</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav" >
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('home') }}">Home</a>
            </li>
            {% if current_user.is_authenticated %}
                
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('available_products') }}">Products</a>
                </li>
                
                

                {% if current_user.is_authenticated and current_user.role == "Staff"  %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('user_orders') }}">My Orders</a>
                </li>
                {% endif %}
                
                {% if current_user.is_authenticated and current_user.role == "Admin"  %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('suppliers') }}">Suppliers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('purchase_orders') }}">Purchase Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('categories') }}">Categories</a>
                    </li>
                
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </li>
            {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('register') }}">Register</a>
                </li>
            {% endif %}
        </ul>
    </div>
</nav>
<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert alert-info" role="alert">
                {% for category, message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
{% endblock %}

{% block content %}
<div class="container">
    <h2>Inventory</h2>
    <table class="table table-bordered" id="inventory-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr id="product-{{ item.product_id }}" data-product-id="{{ item.product_id }}">
                <td>{{ item.product.name }}</td>
                <td class="quantity">{{ item.quantity }}</td>
                <td class="last-updated">{{ item.last_updated }}</td>
                <a class="nav-link" href="{{ url_for('edit_product') }}"> Edit Product </a>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Barcode Scanner -->
    <div id="scanner-container">
        <h3>Scan Barcode</h3>
        <div id="interactive" class="viewport"></div>
    </div>
</div>

<!-- Include QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var socket = io('/inventory');

        socket.on('connect', function() {
            console.log('Connected to Socket.IO server.');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from Socket.IO server.');
        });

        socket.on('inventory_update', function(data) {
            var productRow = document.getElementById('product-' + data.product_id);
            if (productRow) {
                productRow.querySelector('.quantity').textContent = data.quantity;
                var currentDate = new Date();
                productRow.querySelector('.last-updated').textContent = currentDate.toISOString();
            }
        });

        Quagga.init({
            inputStream: {
                type: "LiveStream",
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment" // or user for front camera
                }
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
            }
        }, function(err) {
            if (err) {
                console.log(err);
                return;
            }
            console.log("Initialization finished. Ready to start");
            Quagga.start();
        });

        Quagga.onDetected(function(data) {
            const code = data.codeResult.code;
            alert("Barcode detected: " + code);

            // Send barcode to backend for processing
            fetch('/process_barcode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ barcode: code })
            }).then(response => response.json())
              .then(data => {
                  console.log(data);
                  // Handle response
                  if (data.status === 'success') {
                      // Update inventory table if necessary
                      var productRow = document.getElementById('product-' + data.product_id);
                      if (productRow) {
                          productRow.querySelector('.quantity').textContent = data.quantity;
                          var currentDate = new Date();
                          productRow.querySelector('.last-updated').textContent = currentDate.toISOString();
                      }
                  } else {
                      console.error('Product not found');
                  }
              }).catch((error) => {
                  console.error('Error:', error);
              });
        });
    });
</script>
{% endblock %}